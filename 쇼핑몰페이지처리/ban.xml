<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ban">

<!--  벤추가 쿼리-->
    <insert id="insert" parameterType="mybatis.vo.BanVO">
        INSERT INTO member_ban (mb_idx, ban_reason, ban_start, ban_end)
        VALUES
        (#{mb_idx}, #{ban_reason}, #{ban_start, jdbcType=DATE}, #{ban_end, jdbcType=DATE})
    </insert>

    <!-- 탈퇴 및 정지 회원 전체 조회 + 페이징 -->
<!--  쪼인해서 회원 + 정지 이력도 가져와버림-->
    <select id="getBlockedMembers" parameterType="map" resultMap="blockedMap">
        SELECT
        m.mb_idx, m.mb_name, m.mb_id, m.mb_gender, m.mb_email, m.mb_phone,
        m.mb_rank, m.mb_birth, m.mb_status, m.mb_reg_date,
        b.ban_reason, b.ban_start, b.ban_end
        FROM members m
        LEFT JOIN member_ban b ON m.mb_idx = b.mb_idx
        WHERE
        <choose>
            <when test="mb_status == 'all'">
                m.mb_status IN (0, 2)
            </when>
            <otherwise>
                m.mb_status = #{mb_status}
            </otherwise>
        </choose>
        ORDER BY m.mb_idx DESC
        LIMIT #{start}, #{pageSize}
    </select>


    <resultMap id="blockedMap" type="mybatis.vo.MembersVO">
        <result property="mb_idx" column="mb_idx"/>
        <result property="mb_name" column="mb_name"/>
        <result property="mb_id" column="mb_id"/>
        <result property="mb_gender" column="mb_gender"/>
        <result property="mb_email" column="mb_email"/>
        <result property="mb_phone" column="mb_phone"/>
        <result property="mb_rank" column="mb_rank"/>
        <result property="mb_birth" column="mb_birth"/>
        <result property="mb_status" column="mb_status"/>
        <result property="mb_reg_date" column="mb_reg_date"/>
        <!-- 정지 정보 -->
        <result property="ban_reason" column="ban_reason"/>
        <result property="ban_start" column="ban_start"/>
        <result property="ban_end" column="ban_end"/>
    </resultMap>

    <!-- 검색 + 탈퇴 및 정지 회원 조회 + 페이징 -->
<!--  쪼인해서 밴 이력도 가져와버림-->
    <select id="searchBlockedMembers" parameterType="map" resultMap="blockedMap">
        SELECT
        m.mb_idx, m.mb_name, m.mb_id, m.mb_gender, m.mb_email, m.mb_phone,
        m.mb_rank, m.mb_birth, m.mb_status, m.mb_reg_date,
        b.ban_reason, b.ban_start, b.ban_end
        FROM members m
        LEFT JOIN member_ban b ON m.mb_idx = b.mb_idx
        WHERE
        <choose>
            <when test="mb_status == 'all'">
                m.mb_status IN (0, 2)
            </when>
            <otherwise>
                m.mb_status = #{mb_status}
            </otherwise>
        </choose>
        <choose>
            <when test="searchType == 'mb_name'"> AND m.mb_name LIKE #{searchKeyword} </when>
            <when test="searchType == 'mb_id'"> AND m.mb_id LIKE #{searchKeyword} </when>
            <when test="searchType == 'mb_email'"> AND m.mb_email LIKE #{searchKeyword} </when>
            <when test="searchType == 'mb_rank'"> AND m.mb_rank LIKE #{searchKeyword} </when>
        </choose>
        ORDER BY m.mb_idx DESC
        LIMIT #{start}, #{pageSize}
    </select>


    <!-- 총 회원 수 -->
    <select id="countBlockedMembers" parameterType="map" resultType="int">
        SELECT COUNT(*) FROM members
        WHERE
        <choose>
            <when test="mb_status == 'all'">
                mb_status IN (0, 2)
            </when>
            <otherwise>
                mb_status = #{mb_status}
            </otherwise>
        </choose>
        <choose>
            <when test="searchType == 'mb_name'"> AND mb_name LIKE #{searchKeyword} </when>
            <when test="searchType == 'mb_id'"> AND mb_id LIKE #{searchKeyword} </when>
            <when test="searchType == 'mb_email'"> AND mb_email LIKE #{searchKeyword} </when>
            <when test="searchType == 'mb_rank'"> AND mb_rank LIKE #{searchKeyword} </when>
        </choose>
    </select>

    <!--  정지및 탈퇴 총 회원수-->
    <select id="countBlockedMembersTotal" parameterType="String" resultType="int">
        SELECT COUNT(*) FROM members
        WHERE
        <choose>
            <when test="mb_status == 'all'">
                mb_status IN (0, 2)
            </when>
            <otherwise>
                mb_status = #{mb_status}
            </otherwise>
        </choose>
    </select>
</mapper>
